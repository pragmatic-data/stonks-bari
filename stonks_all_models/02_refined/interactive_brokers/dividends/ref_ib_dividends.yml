version: 2

models:

  - name: REFH_IB_DIVIDENDS
    description: |
      Individual cash transactions for DIVIDENDS in portfolios hold on Interactive Broker.
      
      In general for each divident payment there are multiple rows.
      Commonly there is one row for the Gross dividend and one for the tax withold, 
      but there can be no tax or the dividend can be split in real dividend and payment in liew (when someone else 
      is borrowing the title to short it) or there can be other costs, like ADR pass-through costs.

      Cash Transactions are immutable, so rows cannot be changed (execept for our manual restatements, if we want to do that).
      To change/fix a dividend payout after the initial transaction is recorded it is common that two new transactions
      are issued with the same settle date of the original transaction (when the dividend was payable), 
      but the record date of the time of the correction. 
      The first of the new TXs opposes the original TX and the second enters the correct information.

      The Transaction Type column explains the content of each row.
      The settle date is the effectivity date, i.e. when the information has to be accounted for.
      The report date is when the information arrived.
      
    columns:
      - name: TRANSACTION_HKEY
        description: HKEY / PK is not null
        data_tests:
          - not_null
          - unique    # This checks that the TX have (or we take) only one versions 
      - name: Transaction_ID
        description: BK is not null & unique
        data_tests:
          - not_null
          - unique
      - name: concat(BROKER_CODE, LISTING_EXCHANGE, DIM_SECURITY_SYMBOL, SECURITY_CODE)
        description: Position BK is not null for position related transactions
        data_tests:
          - not_null
      - name: POSITION_HKEY
        data_tests:
          - relationships:
              to: ref('REFH_REPORTED_POSITIONS')
              field: POSITION_HKEY
      - name: PORTFOLIO_HKEY
        data_tests:
          - relationships:
              to: ref('REF_IB_PORTFOLIOS')
              field: PORTFOLIO_HKEY
      - name: DIM_SECURITY_HKEY
        data_tests:
          - relationships:
              to: ref('REFH_IB_SECURITIES')
              field: SECURITY_HKEY

  - name: AGG_IB_DIVIDENDS
    description: |
      Aggregated cash transactions by position and settlement date for DIVIDENDS in portfolios hold on Interactive Broker.
      
      Each row should account for one divided payment, detailing the gross, net and tax payments both
      in trading (FX) and base currency.

      Each row should group all different types of payment, taxes and costs for a single payment (settlement date),
      including fixes and restatements arrived later at any time.
      
    data_tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - POSITION_HKEY
            - DIVIDEND_SETTLEMENT_DATE
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - BROKER_CODE
            - CLIENT_ACCOUNT_CODE
            - LISTING_EXCHANGE
            - SECURITY_CODE
            - DIVIDEND_SETTLEMENT_DATE

      - dbt_utils.expression_is_true: # precise, but works only for decimal number
          expression: NET_CASH_RECIVED_IN_FX + TAX_PAID_IN_FX + COSTS_PAID_IN_FX = GROSS_DIVIDEND_RECIVED_IN_FX

      - dbt_utils.expression_is_true: # less pprecise, but works also for floating point number
          expression: "abs(NET_CASH_RECIVED_IN_FX + TAX_PAID_IN_FX + COSTS_PAID_IN_FX - GROSS_DIVIDEND_RECIVED_IN_FX) < 0.01"


    columns:
      - name: DIVIDEND_HKEY
        description: PK. A surrogate key built on the columns of the business key.
        data_tests:
          - unique
          - not_null
      - name: NET_CASH_RECIVED_IN_FX
        description: |
          The net monetary amount settled on a certain date.
          Positive amounts mean cash received in the account, negative cash paid out.

          In general it should be the net dividend paid on the date, but on some dates there are just adjustments 
          (as the settlement dates are not properly aligned with the original dividend payment).

      - name: GROSS_DIVIDEND_RECIVED_IN_FX
        description: |
          The Gross dividend amount received on the date. 
          Positive amounts mean cash received in the account, negative cash paid out.
          It can be zero in dates when there are just tax or cost adjustments.
        data_tests:
          - not_null

      - name: TAX_PAID_IN_FX
        description: |
          The tax amount paid on the date.
          Positive amounts mean cash paid out of the account, negative cash received (from adjustments).

      - name: COSTS_PAID_IN_FX
        description: |
          The other costs paid on the date, usually ADR costs.
          Positive amounts mean cash paid out of the account, negative cash received (from adjustments).
